// Generated by CoffeeScript 1.4.0

define(['jquery', 'index', 'jquery.migrate', 'fancybox', 'fileupload', 'form'], function(jQuery, Index) {
  Index = Index || {};
  Index.Admin = (function(Admin) {
    Admin.manage = (function() {
      var bindEvents, confirmDelete, getForm, remove, __FileUploadHiddden, __addButton, __cancelCropButton, __cropForm, __cropImage, __cropModal, __deleteButton, __editButton, __fancyboxImage, __fileUploadButton, __fileUploadForm, __fileUploadInput, __fileUploadThumbnail, __formElement, __formModal, __itemClass, __itemCurrent, __publishButtom, __saveButton, __saveCropButton, _bindCropEvents, _hideProgressBar, _showProgressBar, _showThumbnail, _triggerAjaxForm, _triggerCropForm, _triggerFileUpload, _updateCropCoords;
      __formModal = '';
      __formElement = 'form.modal-form';
      __itemClass = '.item';
      __fancyboxImage = '.image-fancybox';
      __addButton = '.btn-add';
      __editButton = '.btn-edit';
      __deleteButton = '.btn-remove';
      __saveButton = '.btn-save-widget';
      __publishButtom = '.btn-generate';
      __fileUploadForm = '#fileupload-form';
      __fileUploadInput = '#fileupload-input';
      __fileUploadButton = '.fileinput-button';
      __fileUploadThumbnail = '.fileupload-thumbnail';
      __FileUploadHiddden = '.fileupload-hidden';
      __itemCurrent = '';
      __cropModal = '';
      __saveCropButton = '.btn-save-crop';
      __cancelCropButton = '.btn-cancel-crop';
      __cropForm = 'form.crop-form';
      __cropImage = 'img.jcrop-image';
      getForm = function(target, action) {
        return jQuery.ajax({
          beforeSend: function() {
            return Index.uiBlocker();
          },
          url: target.attr('href'),
          type: 'GET',
          dataType: 'html'
        }).done(function(data) {
          var modal;
          if (data === 'undefined' || data === '') {
            return false;
          }
          modal = jQuery(Index.modals.widgetForm);
          jQuery(modal).find('#modalBody').html(data);
          jQuery(modal).find('#modalLabel').html(action === 'add' ? 'Novo' : 'Editar');
          jQuery(modal).modal();
          __formModal = modal;
          jQuery(__formModal).on('hidden', function() {
            return jQuery(this).remove('.modal');
          });
          _triggerFileUpload();
          return _triggerAjaxForm();
        }).always(function() {
          return Index.uiBlocker();
        });
      };
      _triggerAjaxForm = function() {
        return jQuery(__formModal).find(__formElement).ajaxForm({
          beforeSubmit: function() {
            return Index.uiBlocker();
          },
          success: function(data) {
            Index.uiBlocker();
            jQuery(__formModal).modal('hide');
            return setTimeout(function() {
              return window.location.href = document.URL;
            }, 1300);
          },
          error: function() {
            return Index.uiBlocker();
          }
        });
      };
      _triggerFileUpload = function() {
        jQuery(__formModal).find(__fileUploadButton).bind('click', function() {
          jQuery(__formModal).find(__fileUploadInput).click();
          return __itemCurrent = jQuery(this).parents(__itemClass);
        });
        return jQuery(__formModal).find(__fileUploadForm).fileupload({
          dataType: 'json',
          add: function(e, data) {
            return data.submit();
          },
          progressall: function(e, data) {
            var progress, progressBar;
            progressBar = _showProgressBar();
            progress = parseInt(data.loaded / data.total * 100, 10);
            if (progressBar !== false) {
              return jQuery(progressBar).children('.bar').css('width', progress + '%');
            }
          },
          done: function(e, data) {
            _hideProgressBar();
            return _triggerCropForm(data.result);
          }
        });
      };
      _showProgressBar = function() {
        var progressBar;
        progressBar = jQuery(__itemCurrent).find('.progress');
        if (progressBar.length === 0) {
          return false;
        }
        jQuery(progressBar).removeClass('fade');
        return progressBar;
      };
      _hideProgressBar = function() {
        var progressBar;
        progressBar = jQuery(__itemCurrent).find('.progress');
        if (progressBar.length > 0) {
          return jQuery(progressBar).addClass('fade');
        }
      };
      _triggerCropForm = function(data) {
        var modal;
        if (!(data instanceof Object)) {
          return false;
        }
        if (data.success === false) {
          return Index.modals.showAlert(data.message);
        }
        modal = jQuery(Index.modals.widgetCrop);
        jQuery('#modalBody', modal).html(data.result.body);
        jQuery('#modalLabel', modal).html(data.result.label);
        __cropModal = modal;
        jQuery(__cropModal).find('.max_height').val(crop_height);
        jQuery(__cropModal).find('.max_width').val(crop_width);
        jQuery(__cropModal).find(__cropImage).Jcrop({
          onChange: _updateCropCoords,
          onSelect: _updateCropCoords,
          aspectRatio: crop_width / crop_height,
          minSize: [crop_width, crop_height],
          setSelect: [0, 0, crop_width, crop_height]
        }, function() {
          jQuery(__cropModal).modal();
          return jQuery(__cropModal).on('hidden', function() {
            return jQuery(this).remove('.modal');
          });
        });
        _showThumbnail(data.result.image);
        _bindCropEvents();
        return jQuery(__cropModal).find(__cropForm).ajaxForm({
          beforeSubmit: function() {
            return Index.uiBlocker();
          },
          success: function(data) {
            Index.uiBlocker();
            if (!(data instanceof Object)) {
              return false;
            }
            if (data.success === false) {
              return Index.modals.showAlert(data.message);
            }
            jQuery(__cropModal).modal('hide');
            _showThumbnail(data.result.image);
            return jQuery(__itemCurrent).find(__FileUploadHiddden).val(data.result.image_path);
          },
          error: function() {
            return jQuery.unblockUI();
          }
        });
      };
      _bindCropEvents = function() {
        jQuery(__cropModal).find(__cancelCropButton).bind('click', function() {
          return jQuery(__cropModal).modal('hide');
        });
        return jQuery(__cropModal).find(__saveCropButton).bind('click', function() {
          return jQuery(__cropModal).find(__cropForm).submit();
        });
      };
      _updateCropCoords = function(coords) {
        jQuery(__cropModal).find('.x_d').val(coords.x);
        jQuery(__cropModal).find('.y_d').val(coords.y);
        jQuery(__cropModal).find('.w_sel').val(coords.w);
        return jQuery(__cropModal).find('.h_sel').val(coords.h);
      };
      _showThumbnail = function(image) {
        var time;
        time = new Date().getTime();
        return jQuery(__itemCurrent).find(__fileUploadThumbnail).attr('src', image + '?' + time);
      };
      confirmDelete = function(target) {
        var id, modal;
        id = jQuery(target).closest('td').find(__deleteButton).attr('rel');
        modal = jQuery(Index.modals.confirm);
        jQuery('#modalBody', modal).html('Deseja deletar o item?');
        jQuery('#modalLabel', modal).html('Deletar');
        jQuery(modal).modal();
        jQuery(modal).on('hidden', function() {
          return jQuery(this).remove('.modal');
        });
        return jQuery(modal).find('.btn-confirm-modal').bind('click', function() {
          jQuery(modal).modal('hide');
          return remove(id);
        });
      };
      remove = function(id) {
        return jQuery.ajax({
          url: Index.ajaxUrl,
          type: 'post',
          dataType: 'json',
          data: {
            id: id,
            ajaxAction: 'delete'
          },
          beforeSend: function() {
            return Index.uiBlocker();
          }
        }).done(function(data) {
          var title;
          if (!(data instanceof Object)) {
            return false;
          }
          if (data.success === true) {
            title = 'Sucesso!';
          } else {
            title = false;
          }
          Index.modals.showAlert(data.message, title);
          if (data.success === true) {
            return setTimeout(function() {
              return window.location.href = document.URL;
            }, 2000);
          }
        }).always(function() {
          return Index.uiBlocker();
        });
      };
      bindEvents = function() {
        jQuery(__addButton).bind('click', function(event) {
          event.preventDefault();
          return getForm(jQuery(this), 'add');
        });
        jQuery(__editButton).bind('click', function(event) {
          var id;
          event.preventDefault();
          id = jQuery(this).attr('rel');
          return getForm(jQuery(this), 'edit');
        });
        jQuery(__deleteButton).bind('click', function(event) {
          event.preventDefault();
          return confirmDelete(jQuery(this));
        });
        jQuery(__saveButton).live('click', function(event) {
          return jQuery(__formModal).find(__formElement).submit();
        });
        return jQuery(__fancyboxImage).fancybox();
      };
      return {
        init: function() {
          return bindEvents();
        }
      };
    })();
    return Admin;
  })(Index || {});
  return jQuery(function() {
    return Index.Admin.manage.init();
  });
});
